# k8s

https://kubernetes.io/ja/docs/setup/production-environment/tools/kubeadm/install-kubeadm/

## swapoff

k8s ように必要

```sh
sudo swapoff /swap.img
sudo rm /swap.img
```

## install

1.33 系に変更する(rancher のため)

```bash
sudo apt-get update
# apt-transport-httpsはダミーパッケージの可能性があります。その場合、そのパッケージはスキップできます
sudo apt-get install -y apt-transport-https ca-certificates curl gpg
```

```bash
# `/etc/apt/keyrings`フォルダーが存在しない場合は、curlコマンドの前に作成する必要があります。下記の備考を参照してください。
# sudo mkdir -p -m 755 /etc/apt/keyrings
curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.34/deb/Release.key | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
```

```bash
# これにより、/etc/apt/sources.list.d/kubernetes.listにある既存の設定が上書きされます
echo 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.34/deb/ /' | sudo tee /etc/apt/sources.list.d/kubernetes.list
```

```bash
sudo apt-get update
sudo apt-get install -y kubelet kubeadm kubectl
sudo apt-mark hold kubelet kubeadm kubectl
```

## kubelet のプロキシ設定

```bash
# kubelet用の環境変数ファイル作成
# sudo tee /etc/default/kubelet <<EOF
# KUBELET_EXTRA_ARGS=--cluster-dns=10.96.0.10 --cluster-domain=cluster.local
# HTTP_PROXY=http://ufproxy.b.cii.u-fukui.ac.jp:8080/
# HTTPS_PROXY=http://ufproxy.b.cii.u-fukui.ac.jp:8080/
# NO_PROXY=.u-fukui.ac.jp,localhost,127.0.0.1,10.0.0.0/8,192.168.0.0/16,172.16.0.0/12,.local,.cluster.local
# EOF

# sudo systemctl daemon-reload
# sudo systemctl restart kubelet


# kubelet用プロキシ設定
sudo mkdir -p /etc/systemd/system/kubelet.service.d
sudo tee /etc/systemd/system/kubelet.service.d/http-proxy.conf <<EOF
[Service]
Environment="HTTP_PROXY=http://ufproxy.b.cii.u-fukui.ac.jp:8080/"
Environment="HTTPS_PROXY=http://ufproxy.b.cii.u-fukui.ac.jp:8080/"
Environment="NO_PROXY=.u-fukui.ac.jp,localhost,127.0.0.1,10.0.0.0/8,192.168.0.0/16,172.16.0.0/12,.local,.cluster.local"
EOF

# kubelet追加パラメータ設定
sudo tee /etc/default/kubelet <<EOF
KUBELET_EXTRA_ARGS="--cluster-dns=10.96.0.10 --cluster-domain=cluster.local"
EOF

# 設定の適用
sudo systemctl daemon-reload
sudo systemctl restart kubelet

```

# ip

https://kubernetes.io/ja/docs/setup/production-environment/container-runtimes/

```bash
cat <<EOF | sudo tee /etc/modules-load.d/k8s.conf
overlay
br_netfilter
EOF

sudo modprobe overlay
sudo modprobe br_netfilter

# この構成に必要なカーネルパラメーター、再起動しても値は永続します
cat <<EOF | sudo tee /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-iptables  = 1
net.bridge.bridge-nf-call-ip6tables = 1
net.ipv4.ip_forward                 = 1
EOF

# 再起動せずにカーネルパラメーターを適用
sudo sysctl --system
```

```bash
lsmod | grep br_netfilter
lsmod | grep overlay
```

```bash
sysctl net.bridge.bridge-nf-call-iptables net.bridge.bridge-nf-call-ip6tables net.ipv4.ip_forward
```
